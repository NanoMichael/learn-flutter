# Fast text layout 性能对比

以下简单测试了 Flutter minikin 和 fast text layout 的性能。

测试机型：

OnePlus 10 pro，Android 12

OnePlus 6, Android 8

每轮测试跑 1000 次，单位微秒。

## 长文本

5000 个 CJK 字符：

OnePlus 10 pro:

| |avg |max |min|theta|p20|p50|p80|
|-|-|-|-|-|-|-|-|
|minikin|3678.89|5935|3219|201.49|3549|3659|3776|
|Skia font|1323.31|1430|1240|38.36|1284|1331|1356|
|harfbuzz|800.73|1676|745|46.17|768|800|819|
|hb-font|204.91|1758|166|103.69|175|184|201|
|cmap|102.40|1422|52|33.04|68|81|91|

OnePlus 6：

||avg|max|min|theta|p20|p50|p80|
|-|-|-|-|-|-|-|-|
|minikin|15779.39|267431|10963|8927.38|12080|16096|17311|
|Skia font|3944.80|71994|3517|2978.06|3690|3757|3834|
|harfbuzz|3846.98|5423|2712|671.21|2895|4125|4367|
|hb-font|1577.44|4397|1474|132.21|1532|1556|1600|
|cmap|597.75|1623|520|78.56|557|575|617|

## 短文本

20 个 CJK 字符：

OnePlus 10 pro:

||avg|max|min|theta|p20|p50|p80|
|-|-|-|-|-|-|-|-|
|minikin|81.34|1135|43|80.53|48|53|85|
|Skia font|23.00|886|9|29.98|11|23|28|
|harfbuzz|46.80|1592|16|70.95|17|25|51|
|hb-font|23.33|771|9|32.96|14|21|25|
|cmap|15.54|429|8|22.50|9|11|16|

OnePlus 6:

||avg|max|min|theta|p20|p50|p80|
|-|-|-|-|-|-|-|-|
|minikin|171.37|1537|147|68.04|152|159|177|
|Skia font|62.30|355|42|24.22|47|55|71|
|harfbuzz|51.79|510|41|26.41|43|46|52|
|hb-font|60.84|564|53|20.99|55|57|62|
|cmap|42.98|1356|32|49.53|33|34|50|

## 总结

大体上看 minkin 约为 CJK 耗时的 2.5 倍，且更不稳定（标准差更大）。使用自定义 cmap 后性能耗时达到了 minikin 的四十分之一（因为不需要通过上下文进行 shape，且对 cmap 进行了优化，使用跳表优化了寻找字形的时间）。短文本中最大耗时均有偏离平均值较大的值，猜测是在进行垃圾回收（待验证）。另外在测试过程中，第一次测量均有很大耗时（大概是平均值的 2 倍），调试发现是寻找字体资源导致的，如果声明字体 family 会减少这部分耗时（表中数据是已除这部分异常数据）。在编写 CJK 单独布局过程中又发现了很多可以优化的地方，待完成之后再做一次对比。
